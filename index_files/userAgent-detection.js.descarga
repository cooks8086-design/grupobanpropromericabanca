$(document).ready(function ($) {
    var currentPageName = window.location.href.slice(window.location.href.indexOf('?') + 1).split("/").pop();

    if (currentPageName === undefined || currentPageName === "") {
        currentPageName = "home.aspx";
    }


    //Tracks the event for when the click call button in the header is clicked.
    $("a[href^='tel']").each(function () {
        $(this).click(function () {
            if (this.id != 'clickToTextHeaderEvent' && this.id != 'clickToCallHeaderEvent') {
                trackerHook(277);
            }
        });
    });



    //Tracks the event when the get directions button is clicked. 
    $('#mobileDirectionsButtonEvent').click(function () {
        if (currentPageName == '') {
            currentPageName = 'Home';
        }
        trackerHook(276);
    });
    if (jQuery.browser.mobile) {
        if (navigator.userAgent.match(/IEMobile\/10\.0/)) {
            var msViewportStyle = document.createElement("style")
            msViewportStyle.appendChild(document.createTextNode("@-ms-viewport{width:auto!important}"));
            document.getElementsByTagName("head")[0].appendChild(msViewportStyle);
        }
        $('.carousel-inner').find('.hideOnMobile').each(function () {
            $(this).remove();
        });
        $(".carousel-inner").find(".item:first").addClass("active");

        removeHiddenAndReindexIndicators('hideOnMobile');
        addSlideNumber();

        $(".carousel-indicators li:first").addClass("active");
        $('.tab-content').find("[id^='serviceSpecials']").each(function () {
            $(this).removeAttr('onclick');
        });
        $('#serviceSpecialsHome').find('.serviceSpecials').each(function () {
            $(this).removeAttr('onclick');
        });
        $('#searchRefineModal').find("[id^='collapse']").each(function () {
            $(this).on('shown.bs.collapse', function (e) {
                var selector = "#searchRefineModal a[href='#" + e.target.id + "']";
                window.location.hash = $(selector).attr('id');
            });
        });
        $('.srpVehicleIncentives a').each(function () {
            $(this).unbind('click').attr("target", "_blank");
        });
        $('.srpMobileIncentives a').each(function () {
            $(this).unbind('click').attr("target", "_blank");
        });
        $("#chatIn").find(".hideOnMobile").remove();
        try {
            getMobileChatScriptsDlrOn();
        } catch (Exception) {
            console.log("Error Loading Mobile Chat Scripts, Platform Mobile Function Missing");
        }
    } else {
        $('.carousel-inner').find('.hideOnDesktop').each(function () {
            $(this).remove();
        });
        $(".carousel-inner").find(".item:first").addClass("active");

        removeHiddenAndReindexIndicators('hideOnDesktop');
        addSlideNumber();

        $(".carousel-indicators li:first").addClass("active");
        $("a[href^='tel'].phone-alert").each(function () {
            $(this).click(function (e) {
                e.preventDefault();
                var phoneNum = $(this).attr('href');
                alert(phoneNum.substring(4, phoneNum.length));
            });
        });
        $("#chatIn").find(".hideOnDesktop").remove();
        try {
            getDesktopChatScriptsDlrOn();
        } catch (Exception) {
            console.log("Error Loading Chat Scripts, Platform Desktop Function Missing");
        }
    }
});

function sendSms(phoneNum, link, specialName) {
    jQuery.get('/api/lead/new', {}, function (t) {
        sendSmsWithToken(phoneNum, link, specialName, t);
    }, 'json');
}

function sendSmsWithToken(phoneNum, link, specialName, t) {
    jQuery.post('/api/lead/sms/' + t.token, {
        "Phone": phoneNum,
        "LeadSource": 198,
        "LeadType": 5,
        "MessageLink": link,
        "Comments": "; ; Coupon: " + specialName + ";"
    });
}

$('#modal_submit').click(function () {
    var phoneNum = $('#modal_phone').val();
    phoneNum = phoneNum.replace(/\D/gi, '');
    if (phoneNum.length != 10) {
        window.alert("Invalid Phone Number");
        $('#modal_phone').val('');
        return false;
    } else {
        var specialName = $('#specialSendToMobileName').val();
        var pathname = window.location.href;
        var homePageCheck = pathname.split('\/').pop();
        if (homePageCheck == "") {
            pathname = pathname + "service-parts-specials.aspx";
        }
        pathname = pathname.replace(/\#/gi, '');
        sendSms(phoneNum, pathname, specialName);
    }
});

function removeHiddenAndReindexIndicators(hiddenClass) {
    var homepageCarousels = document.querySelectorAll(`[id^="carousel-"]`);
    homepageCarousels.forEach((homepageCarousel => {
        var hiddenIndicators = homepageCarousel.querySelectorAll(`.carousel-indicators .${hiddenClass}`);
        if (hiddenIndicators.length > 0) {
            hiddenIndicators.forEach((hiddenIndicator) => {
                hiddenIndicator.remove();
            });

            //Reindex indicators
            var slideToCounter = 0;
            var carouselIndicators = homepageCarousel.querySelector('.carousel-indicators');
            var counterIndicators = carouselIndicators.querySelectorAll('li:not(.slide-indicator--basic)');
            counterIndicators.forEach((indicator) => {
                $(indicator).attr("data-slide-to", slideToCounter);
                $(indicator).text(slideToCounter + 1);
                slideToCounter++;
            });

            slideToCounter = 0;
            var bubbleIndicators = carouselIndicators.querySelectorAll('li.slide-indicator--basic');
            bubbleIndicators.forEach(function (indicator) {
                $(indicator).attr("data-slide-to", slideToCounter);
                slideToCounter++
            });
        }

        hideShowCarouselNavigation(homepageCarousel);
    }));
}

function addSlideNumber() {
    var carouselsElements = document.querySelectorAll('[id^="carousel"]');
    carouselsElements.forEach((carouselsElement) => {
        var slides = carouselsElement.querySelectorAll('.carousel-inner .banner-slide');
        for (var i = 0; i < slides.length; i++) {
            slides[i].setAttribute('aria-label', `carousel slide number ${i + 1} of ${slides.length}`);
        }
    });
}

function hideShowCarouselNavigation(carouselElement) {
    var carouselNavigationArrows = carouselElement.querySelector('.carousel-navigation-controls');
    var carouselIndicators = carouselElement.querySelector('.carousel-indicators');
    var carouselPlayPauseControls = carouselElement.querySelector('.carousel-controls');
    var carouselBanners = carouselElement.querySelectorAll('.carousel-inner .item');
    var slideChangeReader = carouselElement.querySelector('slideChangeReader-CorporateCell');

    var carouselHasMoreThanOneBanner = carouselBanners.length > 1;
    if (carouselHasMoreThanOneBanner) {
        carouselNavigationArrows?.removeAttribute('hidden');
        carouselIndicators?.removeAttribute('hidden');
        carouselPlayPauseControls?.removeAttribute('hidden');
        slideChangeReader?.removeAttribute('hidden');
    } else {
        carouselNavigationArrows?.setAttribute('hidden', true);
        carouselIndicators?.setAttribute('hidden', true);
        carouselPlayPauseControls?.setAttribute('hidden', true);
        slideChangeReader?.setAttribute('hidden', true);
    }
}